Monte Carlo Evaluation of Properties Last updated Save as PDF Page ID Contributed by Jack SimonsProfessor Emeritus and Henry Eyring Scientist Chemistry at University of Utah Metropolis Monte CarloUmbrella SamplingContributors and Attributions A tool that has proven extremely powerful in statistical mechanics since computers became fast enough to permit simulations of complex systems is the Monte Carlo MC method This method allows one to evaluate the integrations appearing in the classical partition function described above by generating a sequence of configurations ie locations of all of the molecules in the system as well as of all the internal coordinates of these molecules and assigning a weighting factor to these configurations By introducing an especially efficient way to generate configurations that have high weighting the MC method allows us to simulate extremely complex systems that may contain millions of molecules To appreciate why it is useful to have a tool such as MC lets consider how one might write a computer program to evaluate the classical partition function For a system consisting of Ar atoms in a box of volume at temperature T The classical Hamiltonian consists of a sum of kinetic and interatomic potential energies The integration over the momentum variables can be carried out analytically and allows to be written as The contribution to provided by the integral over the coordinates is often called the configurational partition function If the density of the Ar atoms is high as in a liquid or solid state the potential will depend on the coordinates of the Ar atoms in a manner that would not allow substantial further approximations to be made One would thus be faced with evaluating an integral over spatial coordinates of a function that depends on all of these coordinates If one were to discretize each of the coordinate axes using say points along each axis the numerical evaluation of this integral as a sum over the coordinates would require computational effort scaling as KN Even for Ar atoms with each axis having points this is of the order of computer operations Clearly such a straightforward evaluation of this classical integral would be foolish to undertake The MC procedure allows one to evaluate such highdimensional integrals by not dividing each of the axes into discrete points but rather selecting values of for which the integrand is nonnegligible while also avoiding values of for which the integrand is small enough to neglect By then summing over only values of that meet these criteria the MC process can estimate the integral Of course the magic lies in how one designs a rigorous and computationally efficient algorithm for selecting those that meet the criteria To illustrate how the MC process works let us consider carrying out a MC simulation representative of liquid water at some density r and temperature T One begins by placing water molecules in a box of volume chosen such that reproduces the specified density To effect the MC process we must assume that the total intramolecular and intermolecular potential energy of these water molecules can be computed for any arrangement of the molecules within the box and for any values of the internal bond lengths and angles of the water molecules Notice that as we showed above when considering the Ar example does not include the kinetic energy of the molecules it is only the potential energy Often this energy is expressed as a sum of intramolecular bondstretching and bending contributions one for each molecule plus a pairwise additive intermolecular potential although the MC process does not require that one employ such a decomposition the energy could be computed in other ways if appropriate For example might be evaluated as the BornOppenheimer energy if an ab initio electronic structure calculation on the full molecule system were feasible The MC process does not depend on how is computed but most commonly it is evaluated as shown above Metropolis Monte Carlo In each step of the MC process this potential energy is evaluated for the current positions of the water molecules In its most common and straightforward implementation known as the Metropolis MonteCarlo process a single water molecule is then chosen at random and one of its internal bond lengths or angle or external position or orientation coordinates is selected at random This one coordinate q is then altered by a small amount and the potential energy is evaluated at the new configuration The amount by which coordinates are varied is usually chosen to make the fraction of MC steps that are accepted by following the procedure detailed below approximately This has been shown to optimize the performance of the MC algorithm In implementing the MC process it is usually important to consider carefully how one defines the coordinates that will be used to generate the MC steps For example in the case of Ar atoms discussed earlier it might be acceptable to use the Cartesian coordinates of the atoms However for the water example it would be very inefficient to employ the Cartesian coordinates of the water molecules Displacement of for example one of the atoms along the xaxis while keeping all other coordinates fixed would alter the intramolecular OH bond energy and the HOH bending energy as well as the intermolecular hydrogen bonding energies to neighboring water molecules The intramolecular energy changes would likely be far in excess of unless a very small coordinate change were employed Because it is important to the efficiency of the MC process to make displacements that produce ca acceptance it is better for the water case to make use of coordinates such as the center of mass and orientation coordinates of the water molecules for which larger displacements produce energy changes within a few and smaller displacements of the OH stretching and HOH bending coordinates to keep the energy change within a few Another point to make about how the MC process is often used is that when the intermolecular energy is pair wise additive evaluation of the energy change accompanying the change in requires computational effort that is proportional to the number of molecules in the system because only those factors with or equal to the single molecule that is displaced need be computed This is why pair wise additive forms for are often employed Let us now return to how the MC process is implemented If the energy change is negative ie if the potential energy is lowered by the coordinate displacement the change in coordinate is allowed to occur and the resulting new configuration is counted among the MCaccepted configurations On the other hand if is positive the move from to is not simply rejected to do so would produce an algorithm directed toward finding a minimum on the energy landscape which is not the goal Instead the quantity is used to compute the probability for accepting this energyincreasing move In particular a random number between for example and is selected If the random number is greater than expressed in the same decimal format then the move is rejected If the random number is less than the move is accepted and the new location is included among the set of MCaccepted configurations Then new water molecule and its internal or external coordinate are chosen at random and the entire process is repeated In this manner one generates a sequence of MCaccepted moves representing a series of configurations for the system of water molecules Sometimes this series of configurations is called a Monte Carlo trajectory but it is important to realize that there is no dynamics or time information in this series This set of configurations has been shown to be properly representative of the geometries that the system will experience as it moves around at equilibrium at the specified temperature nb is the only way that information about the molecules kinetic energy enters the MC process but no time or dynamical attributes are contained in it As the series of accepted steps is generated one can keep track of various geometrical and energetic data for each accepted configuration For example one can monitor the distances R among all pairs of oxygen atoms in the water system being discussed and then average this data over all of the accepted steps to generate an oxygenoxygen radial distribution function as shown in Figure Alternatively one might accumulate the intermolecular interaction energies between pairs of water molecules and average this over all accepted configurations to extract the cohesive energy of the liquid water Figure Radial distribution functions between pairs of Oxygen atoms in HO at three different temperatures The MC procedure also allows us to compute the equilibrium average of any property that depends on the coordinates of the molecules Such an average would be written in terms of the normalized coordinate probability distribution function as The denominator in the definition of is of course proportional to the coordinatecontribution to the partition function In the MC process this average is computed by forming the following sum over the M MCaccepted configurations In most MC simulations millions of accepted steps contribute to the above averages At first glance it may seem that such a large number of steps represent an extreme computational burden However recall that straightforward discretization of the axes produced a result whose effort scaled as which is unfeasible even for small numbers of molecules So why do MC simulations work when the straightforward way fails That is how can one handle thousands or millions of coordinates when the above analysis would suggest that performing an integral over so many coordinates would require computations The main thing to understand is that the site discretization of the coordinates is a stupid way to perform the above integral because there are many in fact most coordinate values where the value of the quantity A whose average one wants multiplied by is negligible On the other hand the MC algorithm is designed to select as accepted steps those coordinates for which is nonnegligible So it avoids configurations that are stupid and focuses on those for which the probability factor is largest This is why the MC method works The standard Metropolis variant of the MC procedure was described above where its rules for accepting or rejecting trial coordinate displacements were given There are several other ways of defining rules for accepting or rejecting trial MC coordinate displacements some of which involve using information about the forces acting on the coordinates all of which can be shown to generate a series of MCaccepted configurations consistent with an equilibrium system The book Computer Simulations of Liquids M P Allen and D J Tildesley Oxford U Press New York provides good descriptions of these alternatives to the Metropolis MC method so I will not go further into these approaches here Umbrella Sampling It turns out that the MC procedure as outlined above is a highly efficient method for computing multidimensional integrals of the form where is a normalized positive probability distribution and is any property that depends on the multidimensional variable q There are however cases where this conventional MC approach needs to be modified by using socalled umbrella sampling To illustrate how this is done and why it is needed suppose that one wanted to use the MC process to compute an average with as the weighting factor of a function that is large whenever two or more molecules have high ie repulsive intermolecular potentials For example one could have Such a function could for example be used to monitor when pairs of molecules with centerofmass coordinates RJ and RI approach closely enough to undergo a reaction that requires them to surmount a high intermolecular barrier The problem with using conventional MC methods to compute in such cases is that i favors those coordinates for which the total potential energy is low So coordinates with high are very infrequently accepted ii However is designed to identify events in which pairs of molecules approach closely and thus have high values So there is a competition between and that renders the MC procedure ineffective in such cases because the average one wants to compute involves the product which is small for most values of q What is done to overcome this competition is to introduce a socalled umbrella weighting function that i attains it largest values where is large and ii is positive and takes on values between and so it can be used as shown below to define a proper probability weighting function One then replaces in the MC algorithm by the product and uses this as a weighting function To see how this replacement works we rewrite the average that needs to be computed as follows The interpretation of the last identity is that can be computed by i using the MC process to evaluate the average of but with a probability weighting factor of to accept or reject coordinate changes and ii also using the MC process to evaluate the average of q again with as the weighting factor and finally iii taking the average of divided by the average of to obtain the final result The secret to the success of umbrella sampling is that the product causes the MC process to emphasize in its acceptance and rejection procedure coordinates for which both and and hence are significant Of course the tradeoff is that the quantities and whose averages one computes using as the MC weighting function are themselves susceptible to being very small at coordinates where the weighting function is large Lets consider some examples of when and how one might want to use umbrella sampling techniques Suppose one has one system for which the evaluation of the partition function and thus all thermodynamic properties can be carried out with reasonable computational effort and another similar system ie one whose potential does not differ much from the first for which this task is very difficult Lets call the potential function of the first system and that of the second system The latter systems partition function can be written as follows where is the partition function of the first system and is the ensemble average of the quantity taken with respect to the ensemble appropriate to the first system This result suggests that one can form the ratio of the partition functions by computing the ensemble average of using the first systems weighting function in the MC process Likewise to compute for second system the average value of any property that depends only on the coordinates of the particles one can proceed as follows where is the ensemble average of the quantity taken with respect to the ensemble appropriate to the first system Using the result derived earlier for the ratio this expression for can be rewritten as In this form we are instructed to form the average of for the second system by a forming the ensemble average of using the weighting function for the first system b forming the ensemble average of using the weighting function for the first system and c taking the ratio of these two averages This is exactly what the umbrella sampling device tells us to do if we were to choose as the umbrella function In this example the umbrella is related to the difference in the potential energies of the two systems whose relationship we wish to exploit Under what circumstances would this kind of approach be useful Suppose one were interested in performing a MC average of a property for a system whose energy landscape has many local minima separated by large energy barriers and suppose it was important to sample configurations characterizing the many local minima in the sampling A straightforward MC calculation using as the weighting function would likely fail because a sequence of coordinate displacements from near one local minimum to another local minimum would have very little chance of being accepted in the MC process because the barriers are very high As a result the MC average would likely generate configurations representative of only the systems equilibrium existence near one local minimum rather than representative of its exploration of the full energy landscape However if one could identify those regions of coordinate space at which high barriers occur and construct a function that is large and positive only in those regions one could then use as the umbrella function and compute averages for the system having potential in terms of ensemble averages for a modified system whose potential is In Figure a I illustrate how the original and modified potential landscapes differ in regions between two local minima Figure a Qualitative depiction of the potential for a system having a large barrier and for the umbrellamodified system with potential The MCaccepted coordinates generated using the modified potential would sample the various local minima and thus the entire landscape in a much more efficient manner because they would not be trapped by the large energy barriers By using these MCaccepted coordinates one can then estimate the average value of a property appropriate to the potential having the large barriers by making use of the identity The above umbrella strategy could be useful in generating a good sampling of configurations characteristic of the many local minima which would be especially beneficial if the quantity emphasized those configurations This would be the case for example if measured the intramolecular and nearestneighbor oxygenhydrogen interatomic distances in a MC simulation of liquid water On the other hand if one wanted to use as a measure of the energy needed for a ion to undergo in a M aqueous solution of NaCl a change in coordination number from to as illustrated in Figure b one would need a sampling that is accurate both near the local minima corresponding to the and coordinate and the transitionstate structures Figure b Qualitative depiction of and coordinate ion in water and of the energy profile connecting these two structures Using an umbrella function similar to that discussed earlier to simply lower the barrier connecting the two ion structures may not be sufficient Although this would allow one to sample both local minima its sampling of structures near the transition state would be questionable if the quantity by which the barrier is lowered to allow MC steps moving over the barrier to be accepted with nonnegligible probability is large In such cases it is wise to employ a series of umbrellas to connect the local minima to the transition states Assuming that one has knowledge of the energies and local solvation geometries characterizing the two local minima and the transition state as well as a reasonable guess or approximation of the intrinsic reaction path refer back to Section of Chapter connecting these structures one proceeds as follows to generate a series of socalled windows within each of which the free energy of the solvated ion is evaluated Using the full potential of the system to constitute the unaltered weighting function one multiplies this by an umbrella function to form the umbrellaaltered weighting function In Uq sq is the value of the value of the intrinsic reaction coordinate IRC evaluated for the current geometry of the system q is the value of the IRC characterizing the first window and d is the width of this window The first window could for example correspond to geometries near the coordinate local minimum of the solvated ion structure The width of each window d should be chosen so that the energy variation within the window is no more than a kT in this way the MC process will have a good ie ca acceptance fraction and the configurations generated will allow for energy fluctuations uphill toward the TS of about this amount As the MC process is performed using the above weighting one constructs a histogram for how often the system reaches various values s along the IRC Of course the severe weighting caused by will not allow the system to realize any value of s outside of the window One then creates a second window that connects to the first window ie with and repeats the MC sampling using to generate a second histogram for how often the system reaches various values of s along the IRC within the second window This process is repeated at a series of connected windows whose centers range from the coordinate ion through the transition state and to the coordinate ion After performing this series of umbrellaaltered samplings one has in hand a series of histograms Within the window gives the relative probability of the system being at a point s along the IRC To generate the normalized absolute probability function Ps expressing the probability of being at a point s one can proceed as follows Because the first and second windows are connected at the point one can scale ie multiply it by a constant to match at this common point to produce a new function This new function describes exactly the same relative probability within the second window but unlike it connects smoothly to Because the second and third windows are connected at the point one can scale to match at this common point to produce a new function This process of scaling to match at is repeated until the final window connecting to Upon completing this series of connections one has in hand a continuous probability function which can be normalized In this way one can compute the probability of accessing the TS and the free energy profile at any point along the IRC It is by using a series of connected windows within each of which the MC process samples structures whose energies can fluctuate by that one generates a smooth connection from lowenergy to highenergy eg TS geometries Contributors and Attributions Jack Simons Henry Eyring Scientist and Professor of Chemistry U Utah Telluride Schools on Theoretical Chemistry Integrated by Tomoyuki Hayashi UC Davis